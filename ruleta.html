<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ruleta 3D - Pro Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; }

        #info {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0,0,0,0.9);
            padding: 15px; border-radius: 10px;
            border: 1px solid #ffd700;
            pointer-events: auto;
        }
        .balance { font-size: 24px; color: #ffd700; font-weight: bold; }

        #betting-container {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            pointer-events: auto;
            width: 600px;
        }

        #betting-area {
            background: rgba(0, 40, 10, 0.95);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #daa520;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .chip-selector { display: flex; gap: 10px; }
        .chip {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: 3px dashed white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .chip.active { border-style: solid; transform: translateY(-8px); }

        .chip-10 { background: #3498db; }
        .chip-50 { background: #e67e22; }
        .chip-100 { background: #9b59b6; }
        .chip-500 { background: #c0392b; }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(13, 1fr);
            gap: 4px;
        }
        .num-btn {
            width: 40px; height: 50px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .red { background: #c0392b; }
        .black { background: #2c3e50; }
        .green { background: #27ae60; }

        #spin-btn {
            margin-top: 10px;
            padding: 14px 70px;
            font-size: 20px;
            font-weight: bold;
            background: #ffd700;
            color: black;
            border: none;
            border-radius: 50px;
            cursor: pointer;
        }

        #win-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            padding: 30px;
            border: 4px solid #ffd700;
            display: none;
            pointer-events: auto;
            z-index: 1000;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="info">
        <div class="balance">üí∞ $<span id="balance-val">0</span></div>
    </div>

    <div id="win-msg">
        <h2 id="result-num"></h2>
        <p id="result-text"></p>
        <button onclick="closeWinMsg()">CONTINUAR</button>
    </div>

    <div id="betting-container">
        <div id="betting-area">
            <div class="chip-selector">
                <div class="chip chip-10 active" onclick="selectChip(10, event)">10</div>
                <div class="chip chip-50" onclick="selectChip(50, event)">50</div>
                <div class="chip chip-100" onclick="selectChip(100, event)">100</div>
                <div class="chip chip-500" onclick="selectChip(500, event)">500</div>
            </div>

            <div class="numbers-grid" id="grid-container"></div>

            <button id="spin-btn" onclick="spinWheel()">GIRAR RULETA</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
/* ========= BALANCE DESDE CUENTA ========= */
let session = JSON.parse(localStorage.getItem('session'));
if (!session) {
    alert("Debes iniciar sesi√≥n");
    location.href = "cuenta.html";
}

let balance = session.balance;
document.getElementById("balance-val").innerText = balance;

function saveBalance() {
    session.balance = balance;

    let users = JSON.parse(localStorage.getItem('users'));
    let i = users.findIndex(u => u.user === session.user);
    if (i !== -1) users[i] = session;

    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('session', JSON.stringify(session));
}

/* ========= APUESTAS ========= */
let selectedChip = 10;
let currentBets = [];

function selectChip(val, e) {
    selectedChip = val;
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    e.target.classList.add('active');
}

const reds = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
const wheelOrder = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];

const grid = document.getElementById("grid-container");
[...wheelOrder].sort((a,b)=>a-b).forEach(n => {
    const d = document.createElement("div");
    d.className = `num-btn ${n === 0 ? 'green' : (reds.includes(n) ? 'red' : 'black')}`;
    d.innerText = n;
    d.onclick = () => addBet(n);
    grid.appendChild(d);
});

function addBet(num) {
    if (balance < selectedChip) return alert("Saldo insuficiente");
    balance -= selectedChip;
    currentBets.push(num);
    saveBalance();
    updateUI();
}

function updateUI() {
    document.getElementById("balance-val").innerText = balance;
}

/* ========= THREE.JS ========= */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

camera.position.set(0, 12, 4);
camera.lookAt(0, 0, 0);

scene.add(new THREE.AmbientLight(0x404040));
scene.add(new THREE.PointLight(0xffffff, 1.5, 100).clone().translateY(10));

const wheelGroup = new THREE.Group();
scene.add(wheelGroup);

const base = new THREE.Mesh(
    new THREE.CylinderGeometry(5,5,0.8,64),
    new THREE.MeshPhongMaterial({ color: 0x1a1a1a })
);
wheelGroup.add(base);

wheelOrder.forEach((num, i) => {
    const angle = (i / 37) * Math.PI * 2;
    const box = new THREE.Mesh(
        new THREE.BoxGeometry(0.8, 0.25, 0.6),
        new THREE.MeshPhongMaterial({ color: num === 0 ? 0x27ae60 : (reds.includes(num) ? 0x96281b : 0x000000) })
    );
    box.position.set(Math.cos(angle)*4.4, 0.4, Math.sin(angle)*4.4);
    box.rotation.y = -angle + Math.PI/2;
    wheelGroup.add(box);
});

function animate() {
    requestAnimationFrame(animate);
    wheelGroup.rotation.y += 0.01;
    renderer.render(scene, camera);
}
animate();

/* ========= GIRO ========= */
function spinWheel() {
    if (currentBets.length === 0) return alert("No apostaste");

    let winNum = wheelOrder[Math.floor(Math.random() * 37)];
    let totalWon = 0;

    currentBets.forEach(n => {
        if (n === winNum) totalWon += selectedChip * 36;
    });

    balance += totalWon;
    saveBalance();

    document.getElementById("result-num").innerText = "N√∫mero: " + winNum;
    document.getElementById("result-text").innerText =
        totalWon > 0 ? `üí∞ GANASTE $${totalWon}` : "‚ùå NO GANASTE";

    document.getElementById("win-msg").style.display = "block";
    currentBets = [];
    updateUI();
}

function closeWinMsg() {
    document.getElementById("win-msg").style.display = "none";
}
</script>
</body>
</html>

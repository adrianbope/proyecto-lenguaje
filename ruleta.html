<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ruleta 3D - Pro Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #info { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.9); padding: 15px; border-radius: 10px; border: 1px solid #ffd700; pointer-events: auto; }
        .balance { font-size: 24px; color: #ffd700; font-weight: bold; }

        #betting-container { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            transition: all 0.4s ease; pointer-events: auto; width: 600px;
        }
        .hidden { transform: translateX(-50%) translateY(150%); opacity: 0; }

        #betting-area { 
            background: rgba(0, 40, 10, 0.95); padding: 20px; border-radius: 15px; 
            border: 2px solid #daa520; display: flex; flex-direction: column; align-items: center; gap: 12px;
        }

        .chip-selector { display: flex; gap: 10px; }
        .chip { 
            width: 45px; height: 45px; border-radius: 50%; border: 3px dashed white; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            font-weight: bold;
        }
        .chip.active { transform: translateY(-10px); border-style: solid; }

        .chip-10 { background:#3498db }
        .chip-50 { background:#e67e22 }
        .chip-100 { background:#9b59b6 }
        .chip-500 { background:#c0392b }

        .numbers-grid { display: grid; grid-template-columns: repeat(13,1fr); gap:4px }
        .num-btn { width:40px; height:50px; font-weight:bold; cursor:pointer; position:relative }
        .bet-badge {
            position:absolute; top:-5px; right:-5px; background:gold; color:black;
            font-size:9px; padding:2px 4px; border-radius:10px; display:none;
        }

        .red { background:#c0392b }
        .black { background:#2c3e50 }
        .green { background:#27ae60 }

        .action-btn { padding:8px; cursor:pointer }
        #spin-btn { padding:15px 80px; font-size:20px; font-weight:bold; cursor:pointer }

        #win-msg {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            background:#000; padding:30px; border:3px solid gold; display:none;
            z-index:1000;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="info">
        <div class="balance">ðŸ’° $<span id="balance-val">0</span></div>
        <div id="active-total">Total Apostado: $0</div>
    </div>

    <div id="win-msg">
        <h2>RESULTADO</h2>
        <h1 id="num-result">-</h1>
        <p id="win-amount"></p>
        <button onclick="closeWinMsg()">CONTINUAR</button>
    </div>

    <div id="betting-container">
        <div id="betting-area">
            <div class="chip-selector">
                <div class="chip chip-10 active" onclick="selectChip(10,event)">10</div>
                <div class="chip chip-50" onclick="selectChip(50,event)">50</div>
                <div class="chip chip-100" onclick="selectChip(100,event)">100</div>
                <div class="chip chip-500" onclick="selectChip(500,event)">500</div>
            </div>

            <div class="numbers-grid" id="grid-container"></div>

            <button id="spin-btn" onclick="spinWheel()">GIRAR RULETA</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
/* ========= SESIÃ“N Y BALANCE ========= */
let session = JSON.parse(localStorage.getItem('session'));
if(!session){
    alert("Debes iniciar sesiÃ³n");
    location.href = "cuenta.html";
}

let balance = session.balance;
document.getElementById('balance-val').innerText = balance;

function saveBalance(){
    session.balance = balance;

    let users = JSON.parse(localStorage.getItem('users'));
    let i = users.findIndex(u=>u.user===session.user);
    if(i!==-1) users[i]=session;

    localStorage.setItem('users',JSON.stringify(users));
    localStorage.setItem('session',JSON.stringify(session));
}

/* ========= APUESTAS ========= */
let selectedChip = 10;
let currentBets = [];

function selectChip(val,e){
    selectedChip = val;
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    e.target.classList.add('active');
}

function addBet(type,mult){
    if(balance < selectedChip) return;
    balance -= selectedChip;

    let bet = currentBets.find(b=>b.type===type);
    if(bet) bet.amount+=selectedChip;
    else currentBets.push({type,multiplier:mult,amount:selectedChip});

    saveBalance();
    updateUI();
}

function updateUI(){
    document.getElementById('balance-val').innerText = balance;
}

/* ========= RULETA 3D ========= */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,0.1,1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

camera.position.set(0,12,4);
camera.lookAt(0,0,0);

scene.add(new THREE.AmbientLight(0x404040));
scene.add(new THREE.PointLight(0xffffff,1.5,100).clone().translateY(10));

const wheelGroup = new THREE.Group();
scene.add(wheelGroup);

const wheelBase = new THREE.Mesh(
    new THREE.CylinderGeometry(5,5,0.8,64),
    new THREE.MeshPhongMaterial({color:0x1a1a1a})
);
wheelGroup.add(wheelBase);

const wheelOrder=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const reds=[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];

wheelOrder.forEach((num,i)=>{
    const angle=(i/37)*Math.PI*2;
    const box=new THREE.Mesh(
        new THREE.BoxGeometry(0.8,0.25,0.6),
        new THREE.MeshPhongMaterial({color:num===0?0x27ae60:(reds.includes(num)?0x96281b:0x000)})
    );
    box.position.set(Math.cos(angle)*4.4,0.4,Math.sin(angle)*4.4);
    box.rotation.y=-angle+Math.PI/2;
    wheelGroup.add(box);
});

function animate(){
    requestAnimationFrame(animate);
    wheelGroup.rotation.y+=0.01;
    renderer.render(scene,camera);
}
animate();

/* ========= GIRO ========= */
function spinWheel(){
    if(currentBets.length===0) return;

    let winNum = wheelOrder[Math.floor(Math.random()*37)];
    let totalWon=0;

    currentBets.forEach(b=>{
        if(b.type==winNum.toString())
            totalWon+=b.amount*b.multiplier;
    });

    balance+=totalWon;
    saveBalance();

    document.getElementById('num-result').innerText=winNum;
    document.getElementById('win-amount').innerText=
        totalWon>0?`GANASTE $${totalWon}`:"NO GANASTE";
    document.getElementById('win-msg').style.display='block';

    currentBets=[];
    updateUI();
}

function closeWinMsg(){
    document.getElementById('win-msg').style.display='none';
}
</script>
</body>
</html>
